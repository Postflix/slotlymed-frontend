<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Book Appointment - SlotlyMed</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<!-- Font Awesome - vers√£o confi√°vel -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
:root {
    --primary: #3B82F6;
    --primary-dark: #2563EB;
    --success: #10B981;
    --danger: #EF4444;
    --bg-main: #F8FAFC;
    --bg-card: #FFFFFF;
    --text-main: #1E293B;
    --text-muted: #64748B;
    --border: #E2E8F0;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%);
    color: var(--text-main);
    min-height: 100vh;
    padding: 20px;
    line-height: 1.6;
}

.container {
    max-width: 1000px;
    margin: 0 auto;
}

/* HEADER */
.header {
    background: var(--bg-card);
    padding: 32px;
    border-radius: 16px;
    box-shadow: var(--shadow-md);
    margin-bottom: 24px;
    text-align: center;
    border: 1px solid var(--border);
}

.logo-container {
    margin-bottom: 16px;
}

.logo {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--primary);
}

.doctor-name {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-main);
    margin-bottom: 8px;
}

.specialty {
    font-size: 1.1rem;
    color: var(--text-muted);
    margin-bottom: 16px;
}

.contact-info {
    display: flex;
    gap: 24px;
    justify-content: center;
    flex-wrap: wrap;
    font-size: 0.9rem;
    color: var(--text-muted);
}

.contact-info i {
    color: var(--primary);
    margin-right: 6px;
}

.welcome-message {
    background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
    padding: 16px 20px;
    border-radius: 12px;
    margin-top: 20px;
    font-size: 1rem;
    color: var(--text-main);
    border-left: 4px solid var(--primary);
}

/* MAIN CONTENT */
.main-content {
    display: grid;
    grid-template-columns: 1fr;
    gap: 24px;
}

@media (min-width: 768px) {
    .main-content {
        grid-template-columns: 2fr 1fr;
    }
}

.card {
    background: var(--bg-card);
    padding: 24px;
    border-radius: 16px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border);
}

.card-title {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 20px;
    color: var(--text-main);
    display: flex;
    align-items: center;
    gap: 10px;
}

.card-title i {
    color: var(--primary);
}

/* CALENDAR */
.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--border);
}

.month-display {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-main);
}

.calendar-nav {
    display: flex;
    gap: 8px;
}

.calendar-nav button {
    background: var(--bg-main);
    border: 1px solid var(--border);
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-main);
    transition: all 0.2s;
}

.calendar-nav button:hover:not(:disabled) {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.calendar-nav button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-bottom: 20px;
}

.day-label {
    text-align: center;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-muted);
    padding: 8px 4px;
    text-transform: uppercase;
}

.day-cell {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.day-cell.empty {
    cursor: default;
}

.day-cell.available {
    background: var(--bg-main);
    color: var(--text-main);
}

.day-cell.available:hover {
    background: var(--primary);
    color: white;
    transform: scale(1.05);
}

.day-cell.selected {
    background: var(--primary);
    color: white;
    border-color: var(--primary-dark);
}

.day-cell.unavailable {
    background: #F1F5F9;
    color: #CBD5E1;
    cursor: not-allowed;
}

.day-cell.today {
    border-color: var(--primary);
}

/* TIME SLOTS */
.time-slots-container {
    max-height: 400px;
    overflow-y: auto;
    padding: 4px;
}

.time-slots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
}

.time-slot {
    background: var(--bg-main);
    border: 2px solid var(--border);
    padding: 12px;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}

.time-slot:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
    transform: translateY(-2px);
}

.time-slot.selected {
    background: var(--primary);
    color: white;
    border-color: var(--primary-dark);
}

.no-slots-message {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
}

.no-slots-message i {
    font-size: 3rem;
    color: var(--border);
    margin-bottom: 16px;
}

/* FORM */
.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-main);
    margin-bottom: 8px;
}

.form-label .required {
    color: var(--danger);
}

.form-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 1rem;
    font-family: 'Inter', sans-serif;
    transition: all 0.2s;
    background: var(--bg-card);
}

.form-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-input::placeholder {
    color: #CBD5E1;
}

.form-textarea {
    min-height: 100px;
    resize: vertical;
}

.selected-slot-display {
    background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 20px;
    border-left: 4px solid var(--primary);
}

.selected-slot-display h4 {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 8px;
    text-transform: uppercase;
}

.selected-slot-display p {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-main);
}

.submit-button {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: var(--shadow-md);
}

.submit-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.submit-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* SUCCESS MESSAGE */
.success-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.success-modal.active {
    display: flex;
}

.success-content {
    background: var(--bg-card);
    padding: 40px;
    border-radius: 20px;
    max-width: 500px;
    text-align: center;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.success-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 24px;
}

.success-icon i {
    font-size: 2.5rem;
    color: white;
}

.success-content h2 {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--text-main);
    margin-bottom: 12px;
}

.success-content p {
    font-size: 1rem;
    color: var(--text-muted);
    margin-bottom: 24px;
    line-height: 1.6;
}

.appointment-details {
    background: var(--bg-main);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 24px;
    text-align: left;
}

.appointment-details p {
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-main);
}

.appointment-details i {
    color: var(--primary);
    width: 20px;
}

.close-modal-button {
    width: 100%;
    padding: 14px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.close-modal-button:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
}

/* LOADING STATE */
.loading {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* RESPONSIVE */
@media (max-width: 767px) {
    .header {
        padding: 24px 20px;
    }

    .doctor-name {
        font-size: 1.5rem;
    }

    .contact-info {
        flex-direction: column;
        gap: 8px;
    }

    .calendar-grid {
        gap: 4px;
    }

    .day-cell {
        font-size: 0.8rem;
    }

    .time-slots-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
</head>
<body>

<!-- Language is set by doctor's preference -->

<div class="container">
    <!-- Header -->
    <div class="header">
        <div class="logo-container" id="logoContainer" style="display: none;">
            <img id="doctorLogo" src="" alt="Doctor Logo" class="logo">
        </div>
        <h1 class="doctor-name" id="doctorName">Dr. John</h1>
        <p class="specialty" id="doctorSpecialty" style="display: none;">Cardiologist</p>
        
        <div class="contact-info">
            <span><i class="fas fa-map-marker-alt"></i> <span id="doctorAddress">123 Medical St, New York, NY</span></span>
            <span><i class="fas fa-phone"></i> <span id="doctorPhone">+1 (555) 123-4567</span></span>
            <span><i class="fas fa-envelope"></i> <span id="doctorEmail">doctor@example.com</span></span>
        </div>

        <div class="welcome-message" id="welcomeMessage" style="display: none;">
            Welcome to our clinic! We look forward to seeing you.
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Calendar Section -->
        <div class="card">
            <h2 class="card-title">
                <i class="fas fa-calendar-alt"></i>
                <span data-i18n="select_date">Select Date</span>
            </h2>

            <div class="calendar-header">
                <button class="calendar-nav" onclick="previousMonth()" id="prevBtn">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="month-display" id="monthDisplay">January 2026</div>
                <button class="calendar-nav" onclick="nextMonth()" id="nextBtn">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <div class="calendar-grid" id="calendarGrid">
                <!-- Days will be generated here -->
            </div>

            <h3 class="card-title" style="margin-top: 24px;">
                <i class="fas fa-clock"></i>
                <span data-i18n="select_time">Select Time</span>
            </h3>

            <div class="time-slots-container">
                <div class="time-slots-grid" id="timeSlotsGrid">
                    <div class="no-slots-message">
                        <i class="fas fa-calendar-times"></i>
                        <p data-i18n="select_date_first">Please select a date first</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Section -->
        <div class="card">
            <h2 class="card-title">
                <i class="fas fa-user"></i>
                <span data-i18n="your_info">Your Information</span>
            </h2>

            <div id="selectedSlotDisplay" class="selected-slot-display" style="display: none;">
                <h4 data-i18n="selected_slot">Selected Appointment</h4>
                <p id="selectedSlotText">-</p>
            </div>

            <form id="appointmentForm" onsubmit="submitAppointment(event)">
                <div class="form-group">
                    <label class="form-label" data-i18n="patient_name">
                        Full Name <span class="required">*</span>
                    </label>
                    <input type="text" class="form-input" id="patientName" required 
                           data-i18n-placeholder="name_placeholder">
                </div>

                <div class="form-group">
                    <label class="form-label" data-i18n="patient_phone">
                        Phone Number <span class="required">*</span>
                    </label>
                    <input type="tel" class="form-input" id="patientPhone" required 
                           data-i18n-placeholder="phone_placeholder">
                </div>

                <div class="form-group">
                    <label class="form-label" data-i18n="patient_email">
                        Email <span class="required">*</span>
                    </label>
                    <input type="email" class="form-input" id="patientEmail" required 
                           data-i18n-placeholder="email_placeholder">
                </div>

                <div class="form-group">
                    <label class="form-label" data-i18n="patient_notes">
                        Additional Notes (Optional)
                    </label>
                    <textarea class="form-input form-textarea" id="patientNotes" 
                              data-i18n-placeholder="notes_placeholder"></textarea>
                </div>

                <button type="submit" class="submit-button" id="submitBtn" disabled>
                    <span data-i18n="book_appointment">Book Appointment</span>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="success-modal" id="successModal">
    <div class="success-content">
        <div class="success-icon">
            <i class="fas fa-check"></i>
        </div>
        <h2 data-i18n="success_title">Appointment Confirmed!</h2>
        <p data-i18n="success_message">Your appointment has been successfully scheduled. You will receive a confirmation email shortly.</p>
        
        <div class="appointment-details" id="appointmentDetails">
            <!-- Details will be inserted here -->
        </div>

        <button class="close-modal-button" onclick="closeModal()">
            <span data-i18n="close">Close</span>
        </button>
    </div>
</div>

<script>
// ==================== API CONFIGURATION ====================
const API_BASE_URL = 'https://slotlymed-backend.vercel.app/api';
let realDoctorId = null;

// TRANSLATIONS
const translations = {
    en: {
        select_date: "Select Date",
        select_time: "Select Time",
        select_date_first: "Please select a date first",
        your_info: "Your Information",
        selected_slot: "Selected Appointment",
        patient_name: "Full Name",
        patient_phone: "Phone Number",
        patient_email: "Email",
        patient_notes: "Additional Notes (Optional)",
        name_placeholder: "John Doe",
        phone_placeholder: "+1 (555) 123-4567",
        email_placeholder: "john@example.com",
        notes_placeholder: "Any specific concerns or questions...",
        book_appointment: "Book Appointment",
        success_title: "Appointment Confirmed!",
        success_message: "Your appointment has been successfully scheduled. You will receive a confirmation email shortly.",
        close: "Close",
        no_available_slots: "No available time slots for this date",
        days: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
        months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
    },
    pt: {
        select_date: "Selecione a Data",
        select_time: "Selecione o Hor√°rio",
        select_date_first: "Por favor, selecione uma data primeiro",
        your_info: "Suas Informa√ß√µes",
        selected_slot: "Hor√°rio Selecionado",
        patient_name: "Nome Completo",
        patient_phone: "Telefone",
        patient_email: "Email",
        patient_notes: "Observa√ß√µes Adicionais (Opcional)",
        name_placeholder: "Jo√£o Silva",
        phone_placeholder: "+55 (11) 98765-4321",
        email_placeholder: "joao@exemplo.com",
        notes_placeholder: "Alguma d√∫vida ou preocupa√ß√£o espec√≠fica...",
        book_appointment: "Agendar Consulta",
        success_title: "Consulta Confirmada!",
        success_message: "Sua consulta foi agendada com sucesso. Voc√™ receber√° um email de confirma√ß√£o em breve.",
        close: "Fechar",
        no_available_slots: "Sem hor√°rios dispon√≠veis para esta data",
        days: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"],
        months: ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]
    },
    es: {
        select_date: "Seleccionar Fecha",
        select_time: "Seleccionar Hora",
        select_date_first: "Por favor, seleccione una fecha primero",
        your_info: "Su Informaci√≥n",
        selected_slot: "Cita Seleccionada",
        patient_name: "Nombre Completo",
        patient_phone: "Tel√©fono",
        patient_email: "Email",
        patient_notes: "Notas Adicionales (Opcional)",
        name_placeholder: "Juan P√©rez",
        phone_placeholder: "+34 612 345 678",
        email_placeholder: "juan@ejemplo.com",
        notes_placeholder: "Alguna preocupaci√≥n o pregunta espec√≠fica...",
        book_appointment: "Reservar Cita",
        success_title: "¬°Cita Confirmada!",
        success_message: "Su cita ha sido programada con √©xito. Recibir√° un email de confirmaci√≥n en breve.",
        close: "Cerrar",
        no_available_slots: "No hay horarios disponibles para esta fecha",
        days: ["Dom", "Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b"],
        months: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]
    },
    fr: {
        select_date: "S√©lectionner la Date",
        select_time: "S√©lectionner l'Heure",
        select_date_first: "Veuillez d'abord s√©lectionner une date",
        your_info: "Vos Informations",
        selected_slot: "Rendez-vous S√©lectionn√©",
        patient_name: "Nom Complet",
        patient_phone: "T√©l√©phone",
        patient_email: "Email",
        patient_notes: "Notes Suppl√©mentaires (Optionnel)",
        name_placeholder: "Jean Dupont",
        phone_placeholder: "+33 6 12 34 56 78",
        email_placeholder: "jean@exemple.com",
        notes_placeholder: "Des pr√©occupations ou questions sp√©cifiques...",
        book_appointment: "R√©server un Rendez-vous",
        success_title: "Rendez-vous Confirm√©!",
        success_message: "Votre rendez-vous a √©t√© programm√© avec succ√®s. Vous recevrez un email de confirmation sous peu.",
        close: "Fermer",
        no_available_slots: "Aucun cr√©neau disponible pour cette date",
        days: ["Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"],
        months: ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"]
    },
    de: {
        select_date: "Datum W√§hlen",
        select_time: "Uhrzeit W√§hlen",
        select_date_first: "Bitte w√§hlen Sie zuerst ein Datum",
        your_info: "Ihre Informationen",
        selected_slot: "Ausgew√§hlter Termin",
        patient_name: "Vollst√§ndiger Name",
        patient_phone: "Telefon",
        patient_email: "Email",
        patient_notes: "Zus√§tzliche Notizen (Optional)",
        name_placeholder: "Hans M√ºller",
        phone_placeholder: "+49 151 23456789",
        email_placeholder: "hans@beispiel.com",
        notes_placeholder: "Spezifische Anliegen oder Fragen...",
        book_appointment: "Termin Buchen",
        success_title: "Termin Best√§tigt!",
        success_message: "Ihr Termin wurde erfolgreich gebucht. Sie erhalten in K√ºrze eine Best√§tigungs-E-Mail.",
        close: "Schlie√üen",
        no_available_slots: "Keine verf√ºgbaren Zeitfenster f√ºr dieses Datum",
        days: ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"],
        months: ["Januar", "Februar", "M√§rz", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"]
    },
    it: {
        select_date: "Seleziona Data",
        select_time: "Seleziona Orario",
        select_date_first: "Si prega di selezionare prima una data",
        your_info: "Le Tue Informazioni",
        selected_slot: "Appuntamento Selezionato",
        patient_name: "Nome Completo",
        patient_phone: "Telefono",
        patient_email: "Email",
        patient_notes: "Note Aggiuntive (Opzionale)",
        name_placeholder: "Giovanni Rossi",
        phone_placeholder: "+39 333 1234567",
        email_placeholder: "giovanni@esempio.com",
        notes_placeholder: "Preoccupazioni o domande specifiche...",
        book_appointment: "Prenota Appuntamento",
        success_title: "Appuntamento Confermato!",
        success_message: "Il tuo appuntamento √® stato programmato con successo. Riceverai un'email di conferma a breve.",
        close: "Chiudi",
        no_available_slots: "Nessun orario disponibile per questa data",
        days: ["Dom", "Lun", "Mar", "Mer", "Gio", "Ven", "Sab"],
        months: ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"]
    }
};

// STATE
let currentLanguage = 'en';
let currentDate = new Date();
let selectedDate = null;
let selectedTime = null;
let availableSlots = {};

// MOCK DOCTOR DATA (will come from URL params in production)
const doctorData = {
    name: "Dr. John",
    specialty: "Cardiologist",
    address: "123 Medical St, New York, NY 10001",
    phone: "+1 (555) 123-4567",
    email: "doctor@example.com",
    logo: "",
    welcomeMessage: "Welcome to our clinic! We look forward to seeing you.",
    color: "#3B82F6",
    language: "en",
    schedule: {
        days: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
        start_time: "09:00",
        end_time: "17:00",
        slot_duration_minutes: 30,
        breaks: [{start: "12:00", end: "13:00", name: "Lunch"}]
    }
};

// ==================== BACKEND INTEGRATION ====================
async function loadFromBackend() {
    // MODO 1: PREVIEW - Dados tempor√°rios do painel m√©dico
    const previewSlots = sessionStorage.getItem('tempPreviewSlots');
    const previewDoctor = sessionStorage.getItem('tempPreviewDoctor');
    
    if (previewSlots && previewDoctor) {
        console.log('üëÅÔ∏è PREVIEW MODE - Loading temporary data');
        
        try {
            const doctorPreview = JSON.parse(previewDoctor);
            const slotsPreview = JSON.parse(previewSlots);
            
            // Carregar dados do m√©dico
            doctorData.name = doctorPreview.name;
            doctorData.specialty = doctorPreview.specialty || '';
            doctorData.address = doctorPreview.address;
            doctorData.phone = doctorPreview.phone;
            doctorData.email = doctorPreview.email;
            doctorData.logo = doctorPreview.logo_url || '';
            doctorData.welcomeMessage = doctorPreview.welcome_message || '';
            doctorData.color = doctorPreview.color || '#3B82F6';
            doctorData.language = doctorPreview.language || 'en';
            
            // Carregar slots
            availableSlots = {};
            slotsPreview.forEach(slot => {
                if (!availableSlots[slot.date]) availableSlots[slot.date] = [];
                availableSlots[slot.date].push(slot.time);
            });
            
            console.log('‚úÖ Preview loaded:', slotsPreview.length, 'slots');
            
            // Adicionar banner de preview
            addPreviewBanner();
            
            return true;
        } catch (e) {
            console.error('‚ùå Error loading preview data:', e);
        }
    }
    
    // MODO 2: PRODU√á√ÉO - Dados reais do backend
    const path = window.location.pathname;
    const urlParams = new URLSearchParams(window.location.search);
    realDoctorId = path.split('/').pop() || urlParams.get('id');
    
    if (!realDoctorId || realDoctorId.includes('.html') || realDoctorId === '') {
        console.log('üß™ DEMO MODE - Running locally');
        return false;
    }
    
    try {
        console.log('üì° Loading from backend:', realDoctorId);
        
        const doctorResponse = await fetch(`${API_BASE_URL}/get-doctor?id=${realDoctorId}`);
        const doctorResult = await doctorResponse.json();
        
        if (!doctorResult.success) {
            console.error('‚ùå Doctor not found');
            return false;
        }
        
        const realData = doctorResult.doctor;
        doctorData.name = realData.name;
        doctorData.specialty = realData.specialty || '';
        doctorData.address = realData.address;
        doctorData.phone = realData.phone;
        doctorData.email = realData.email;
        doctorData.logo = realData.logo_url || '';
        doctorData.welcomeMessage = realData.welcome_message || '';
        doctorData.color = realData.color || '#3B82F6';
        doctorData.language = realData.language || 'en';
        
        const slotsResponse = await fetch(`${API_BASE_URL}/get-slots?doctor_id=${realDoctorId}`);
        const slotsResult = await slotsResponse.json();
        
        if (slotsResult.success && slotsResult.slots) {
            availableSlots = {};
            slotsResult.slots.forEach(slot => {
                if (!availableSlots[slot.date]) availableSlots[slot.date] = [];
                availableSlots[slot.date].push(slot.time);
            });
            console.log('‚úÖ Loaded', slotsResult.count, 'slots from backend');
        }
        
        return true;
    } catch (error) {
        console.error('‚ùå Backend error:', error);
        return false;
    }
}

// INITIALIZE
window.onload = async function() {
    const loadedFromBackend = await loadFromBackend();
    
    if (!loadedFromBackend) {
        console.log('üìã Using DEMO data');
    }
    
    currentLanguage = doctorData.language || 'en';
    loadDoctorData();
    
    if (!loadedFromBackend) {
        generateMockSlots();
    }
    
    renderCalendar();
    updateLanguage();
};

function loadDoctorData() {
    if (doctorData.language) {
        currentLanguage = doctorData.language;
        updateLanguage();
    }
    
    document.getElementById('doctorName').textContent = doctorData.name;
    document.getElementById('doctorAddress').textContent = doctorData.address;
    document.getElementById('doctorPhone').textContent = doctorData.phone;
    document.getElementById('doctorEmail').textContent = doctorData.email;
    
    if (doctorData.specialty) {
        document.getElementById('doctorSpecialty').textContent = doctorData.specialty;
        document.getElementById('doctorSpecialty').style.display = 'block';
    }
    
    if (doctorData.logo) {
        document.getElementById('doctorLogo').src = doctorData.logo;
        document.getElementById('logoContainer').style.display = 'block';
    }
    
    if (doctorData.welcomeMessage) {
        document.getElementById('welcomeMessage').textContent = doctorData.welcomeMessage;
        document.getElementById('welcomeMessage').style.display = 'block';
    }
    
    document.documentElement.style.setProperty('--primary', doctorData.color);
}

function generateMockSlots() {
    const schedule = doctorData.schedule;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    for (let i = 0; i < 90; i++) {
        const date = new Date(today);
        date.setDate(date.getDate() + i);
        
        const dayName = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][date.getDay()];
        
        if (!schedule.days.includes(dayName)) continue;
        
        const dateKey = formatDateKey(date);
        availableSlots[dateKey] = [];
        
        const [startHour, startMin] = schedule.start_time.split(':').map(Number);
        const [endHour, endMin] = schedule.end_time.split(':').map(Number);
        
        let currentTime = startHour * 60 + startMin;
        const endTime = endHour * 60 + endMin;
        
        while (currentTime < endTime) {
            const hour = Math.floor(currentTime / 60);
            const min = currentTime % 60;
            const timeStr = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
            
            let isDuringBreak = false;
            for (let brk of schedule.breaks) {
                const [brkStartHour, brkStartMin] = brk.start.split(':').map(Number);
                const [brkEndHour, brkEndMin] = brk.end.split(':').map(Number);
                const brkStart = brkStartHour * 60 + brkStartMin;
                const brkEnd = brkEndHour * 60 + brkEndMin;
                
                if (currentTime >= brkStart && currentTime < brkEnd) {
                    isDuringBreak = true;
                    break;
                }
            }
            
            if (!isDuringBreak) {
                availableSlots[dateKey].push(timeStr);
            }
            
            currentTime += schedule.slot_duration_minutes;
        }
    }
}

function formatDateKey(date) {
    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
}

function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    const monthName = translations[currentLanguage].months[month];
    document.getElementById('monthDisplay').textContent = `${monthName} ${year}`;
    
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';
    
    const dayLabels = translations[currentLanguage].days;
    dayLabels.forEach(day => {
        const label = document.createElement('div');
        label.className = 'day-label';
        label.textContent = day;
        grid.appendChild(label);
    });
    
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    for (let i = 0; i < firstDay; i++) {
        const empty = document.createElement('div');
        empty.className = 'day-cell empty';
        grid.appendChild(empty);
    }
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateKey = formatDateKey(date);
        const hasSlots = availableSlots[dateKey] && availableSlots[dateKey].length > 0;
        const isPast = date < today;
        
        const cell = document.createElement('div');
        cell.className = 'day-cell';
        cell.textContent = day;
        
        if (isPast) {
            cell.classList.add('unavailable');
        } else if (hasSlots) {
            cell.classList.add('available');
            cell.onclick = () => selectDate(date);
        } else {
            cell.classList.add('unavailable');
        }
        
        if (date.getTime() === today.getTime()) {
            cell.classList.add('today');
        }
        
        if (selectedDate && date.getTime() === selectedDate.getTime()) {
            cell.classList.add('selected');
        }
        
        grid.appendChild(cell);
    }
    
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    const now = new Date();
    if (year === now.getFullYear() && month === now.getMonth()) {
        prevBtn.disabled = true;
    } else {
        prevBtn.disabled = false;
    }
    
    const maxDate = new Date();
    maxDate.setMonth(maxDate.getMonth() + 3);
    if (year > maxDate.getFullYear() || (year === maxDate.getFullYear() && month >= maxDate.getMonth())) {
        nextBtn.disabled = true;
    } else {
        nextBtn.disabled = false;
    }
}

function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
}

function selectDate(date) {
    selectedDate = date;
    selectedTime = null;
    renderCalendar();
    renderTimeSlots();
    updateSubmitButton();
}

function renderTimeSlots() {
    const grid = document.getElementById('timeSlotsGrid');
    grid.innerHTML = '';
    
    if (!selectedDate) {
        grid.innerHTML = `
            <div class="no-slots-message">
                <i class="fas fa-calendar-times"></i>
                <p data-i18n="select_date_first">${translations[currentLanguage].select_date_first}</p>
            </div>
        `;
        return;
    }
    
    const dateKey = formatDateKey(selectedDate);
    const slots = availableSlots[dateKey] || [];
    
    if (slots.length === 0) {
        grid.innerHTML = `
            <div class="no-slots-message">
                <i class="fas fa-calendar-times"></i>
                <p data-i18n="no_available_slots">${translations[currentLanguage].no_available_slots}</p>
            </div>
        `;
        return;
    }
    
    slots.forEach(time => {
        const slot = document.createElement('div');
        slot.className = 'time-slot';
        slot.textContent = time;
        slot.onclick = () => selectTime(time);
        
        if (selectedTime === time) {
            slot.classList.add('selected');
        }
        
        grid.appendChild(slot);
    });
}

function selectTime(time) {
    selectedTime = time;
    renderTimeSlots();
    updateSelectedSlotDisplay();
    updateSubmitButton();
}

function updateSelectedSlotDisplay() {
    const display = document.getElementById('selectedSlotDisplay');
    const text = document.getElementById('selectedSlotText');
    
    if (selectedDate && selectedTime) {
        const dateStr = selectedDate.toLocaleDateString(currentLanguage === 'pt' ? 'pt-BR' : currentLanguage, {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        text.textContent = `${dateStr} - ${selectedTime}`;
        display.style.display = 'block';
    } else {
        display.style.display = 'none';
    }
}

function updateSubmitButton() {
    const btn = document.getElementById('submitBtn');
    btn.disabled = !(selectedDate && selectedTime);
}

function submitAppointment(event) {
    event.preventDefault();
    
    const name = document.getElementById('patientName').value;
    const phone = document.getElementById('patientPhone').value;
    const email = document.getElementById('patientEmail').value;
    const notes = document.getElementById('patientNotes').value;
    
    const btn = document.getElementById('submitBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="loading"></span>';
    btn.disabled = true;
    
    if (realDoctorId && !realDoctorId.includes('.html')) {
        // REAL MODE
        const appointmentData = {
            doctor_id: realDoctorId,
            patient_name: name,
            patient_email: email,
            patient_phone: phone,
            date: formatDateKey(selectedDate),
            time: selectedTime,
            notes: notes
        };
        
        fetch(`${API_BASE_URL}/book-appointment`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(appointmentData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessModal({name, phone, email, notes, date: selectedDate, time: selectedTime});
                document.getElementById('appointmentForm').reset();
                selectedDate = null;
                selectedTime = null;
                
                return fetch(`${API_BASE_URL}/get-slots?doctor_id=${realDoctorId}`)
                    .then(r => r.json())
                    .then(slotsData => {
                        if (slotsData.success) {
                            availableSlots = {};
                            slotsData.slots.forEach(slot => {
                                if (!availableSlots[slot.date]) availableSlots[slot.date] = [];
                                availableSlots[slot.date].push(slot.time);
                            });
                        }
                        renderCalendar();
                        renderTimeSlots();
                        updateSelectedSlotDisplay();
                    });
            } else {
                alert('Error: ' + (data.error || 'Failed to book'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Connection error. Please try again.');
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    } else {
        // DEMO MODE
        setTimeout(() => {
            showSuccessModal({name, phone, email, notes, date: selectedDate, time: selectedTime});
            document.getElementById('appointmentForm').reset();
            selectedDate = null;
            selectedTime = null;
            renderCalendar();
            renderTimeSlots();
            updateSelectedSlotDisplay();
            btn.innerHTML = originalText;
        }, 1500);
    }
}

function showSuccessModal(appointment) {
    const modal = document.getElementById('successModal');
    const details = document.getElementById('appointmentDetails');
    
    const dateStr = appointment.date.toLocaleDateString(currentLanguage === 'pt' ? 'pt-BR' : currentLanguage, {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    details.innerHTML = `
        <p><i class="fas fa-calendar"></i> <strong>${dateStr}</strong></p>
        <p><i class="fas fa-clock"></i> <strong>${appointment.time}</strong></p>
        <p><i class="fas fa-user"></i> ${appointment.name}</p>
        <p><i class="fas fa-envelope"></i> ${appointment.email}</p>
        <p><i class="fas fa-phone"></i> ${appointment.phone}</p>
    `;
    
    modal.classList.add('active');
}

function closeModal() {
    document.getElementById('successModal').classList.remove('active');
}

function updateLanguage() {
    const t = translations[currentLanguage];
    
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) {
            el.textContent = t[key];
        }
    });
    
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (t[key]) {
            el.placeholder = t[key];
        }
    });
    
    document.title = `${t.book_appointment} - SlotlyMed`;
}

function addPreviewBanner() {
    const banner = document.createElement('div');
    banner.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
        border-bottom: 3px solid #F59E0B;
        padding: 16px;
        text-align: center;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    `;
    banner.innerHTML = `
        <div style="max-width: 1000px; margin: 0 auto;">
            <h3 style="margin: 0 0 8px 0; color: #92400E; font-size: 1.2rem;">
                üëÅÔ∏è Preview Mode - Patient View
            </h3>
            <p style="margin: 0; color: #78350F; font-size: 0.9rem;">
                This is how patients will see your booking page. Appointment booking is disabled in preview mode.
            </p>
        </div>
    `;
    document.body.prepend(banner);
    document.body.style.paddingTop = '120px';
    
    // Desabilitar bot√£o de booking
    const bookBtn = document.querySelector('button[onclick="bookAppointment()"]');
    if (bookBtn) {
        bookBtn.disabled = true;
        bookBtn.style.opacity = '0.5';
        bookBtn.style.cursor = 'not-allowed';
        bookBtn.textContent = 'Booking Disabled (Preview Mode)';
    }
}

</script>

</body>
</html>
